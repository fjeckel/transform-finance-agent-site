<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Integration Frontend Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .video-card img {
            width: 100%;
            height: 168px;
            object-fit: cover;
        }
        .video-card-content {
            padding: 15px;
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .video-meta {
            color: #666;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç YouTube Integration Frontend Debug Tool</h1>
        
        <div class="test-section info">
            <h3>üìã Test Overview</h3>
            <p>This tool simulates exactly what your users experience when the Discover page loads. It tests the frontend JavaScript calls, network requests, and data processing that happen in the browser.</p>
            <p><strong>Purpose:</strong> Identify client-side issues like CORS problems, network timeouts, or JavaScript errors that server-side tests can't detect.</p>
        </div>

        <div class="test-section">
            <h3>‚öôÔ∏è Configuration</h3>
            <p><strong>Environment:</strong> Production</p>
            <p><strong>Supabase URL:</strong> <span id="supabase-url">https://aumijfxmeclxweojrefa.supabase.co</span></p>
            <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
            <p><strong>Current Time:</strong> <span id="current-time"></span></p>
        </div>

        <div class="test-section">
            <h3>üöÄ Test Controls</h3>
            <button onclick="runAllTests()" id="run-all-btn">Run All Tests</button>
            <button onclick="clearResults()">Clear Results</button>
            <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
            <button onclick="testDirectQuery()">Test Direct Database Query</button>
            <button onclick="testEdgeFunction()">Test Edge Function</button>
            <button onclick="simulateHookBehavior()">Simulate useYouTubeVideos Hook</button>
        </div>

        <div id="test-results"></div>
        
        <div id="video-preview" class="test-section" style="display: none;">
            <h3>üì∫ Video Preview</h3>
            <div id="video-grid" class="video-grid"></div>
        </div>

        <div class="test-section">
            <h3>üìä Network Information</h3>
            <div id="network-info"></div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://aumijfxmeclxweojrefa.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1bWlqZnhtZWNseHdlb2pyZWZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzgwMDksImV4cCI6MjA2Njk1NDAwOX0.71K0TyaDwxCrzanRfM_ciVXGc0jm9-qN_yfckiRmayc'
        };

        let testResults = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('user-agent').textContent = navigator.userAgent;
            document.getElementById('current-time').textContent = new Date().toISOString();
            updateNetworkInfo();
        });

        // Utility functions
        function logTest(testName, success, details = {}) {
            const result = {
                test: testName,
                success,
                details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            displayTestResult(result);
            return success;
        }

        function displayTestResult(result) {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-section ${result.success ? 'success' : 'error'}`;
            
            const statusIcon = result.success ? '‚úÖ' : '‚ùå';
            const statusClass = result.success ? 'status-success' : 'status-error';
            
            let html = `
                <h4><span class="status-indicator ${statusClass}"></span>${statusIcon} ${result.test}</h4>
                <p><strong>Time:</strong> ${result.timestamp}</p>
            `;
            
            if (result.details.message) {
                html += `<p><strong>Message:</strong> ${result.details.message}</p>`;
            }
            
            if (result.details.error) {
                html += `<p><strong>Error:</strong> ${result.details.error}</p>`;
            }
            
            if (result.details.data) {
                html += `<p><strong>Data:</strong></p><pre>${JSON.stringify(result.details.data, null, 2)}</pre>`;
            }
            
            testDiv.innerHTML = html;
            resultsDiv.appendChild(testDiv);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('video-preview').style.display = 'none';
            testResults = [];
        }

        function updateNetworkInfo() {
            const networkDiv = document.getElementById('network-info');
            let info = {
                online: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'Not available',
                cookiesEnabled: navigator.cookieEnabled,
                language: navigator.language,
                platform: navigator.platform,
                screen: {
                    width: screen.width,
                    height: screen.height
                }
            };
            networkDiv.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
        }

        // Test functions
        async function testSupabaseConnection() {
            try {
                console.log('Testing Supabase connection...');
                
                const start = performance.now();
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                    }
                });
                const duration = performance.now() - start;

                if (response.ok) {
                    logTest('Supabase Connection', true, {
                        message: `Connected successfully (${Math.round(duration)}ms)`,
                        data: { status: response.status, responseTime: Math.round(duration) }
                    });
                    return true;
                } else {
                    logTest('Supabase Connection', false, {
                        error: `HTTP ${response.status}: ${response.statusText}`,
                        data: { status: response.status, responseTime: Math.round(duration) }
                    });
                    return false;
                }
            } catch (error) {
                logTest('Supabase Connection', false, {
                    error: error.message,
                    data: { errorType: error.name }
                });
                return false;
            }
        }

        async function testDirectQuery() {
            try {
                console.log('Testing direct database query...');
                
                const start = performance.now();
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/youtube_videos?select=*&order=published_at.desc&limit=10`, {
                    method: 'GET',
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                    }
                });
                const duration = performance.now() - start;

                if (response.ok) {
                    const data = await response.json();
                    logTest('Direct Database Query', true, {
                        message: `Retrieved ${data.length} videos (${Math.round(duration)}ms)`,
                        data: { 
                            count: data.length, 
                            responseTime: Math.round(duration),
                            sample: data.slice(0, 2).map(v => ({
                                video_id: v.video_id,
                                title: v.title?.substring(0, 50) + '...',
                                is_short: v.is_short
                            }))
                        }
                    });
                    return data;
                } else {
                    const errorText = await response.text();
                    logTest('Direct Database Query', false, {
                        error: `HTTP ${response.status}: ${errorText}`,
                        data: { status: response.status, responseTime: Math.round(duration) }
                    });
                    return null;
                }
            } catch (error) {
                logTest('Direct Database Query', false, {
                    error: error.message,
                    data: { errorType: error.name }
                });
                return null;
            }
        }

        async function testEdgeFunction() {
            try {
                console.log('Testing edge function...');
                
                const start = performance.now();
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/youtube-videos?action=list&limit=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                const duration = performance.now() - start;

                if (response.ok) {
                    const data = await response.json();
                    logTest('Edge Function', true, {
                        message: `Retrieved ${data.count || 0} videos (${Math.round(duration)}ms)`,
                        data: { 
                            count: data.count, 
                            responseTime: Math.round(duration),
                            sample: data.videos?.slice(0, 2).map(v => ({
                                video_id: v.video_id,
                                title: v.title?.substring(0, 50) + '...',
                                views: v.views,
                                isShort: v.isShort
                            }))
                        }
                    });
                    return data.videos;
                } else {
                    const errorText = await response.text();
                    logTest('Edge Function', false, {
                        error: `HTTP ${response.status}: ${errorText}`,
                        data: { status: response.status, responseTime: Math.round(duration) }
                    });
                    return null;
                }
            } catch (error) {
                logTest('Edge Function', false, {
                    error: error.message,
                    data: { errorType: error.name }
                });
                return null;
            }
        }

        async function simulateHookBehavior() {
            try {
                console.log('Simulating useYouTubeVideos hook behavior...');
                
                // Step 1: Try edge function (primary path)
                let videos = await testEdgeFunction();
                
                if (!videos || videos.length === 0) {
                    console.log('Edge function failed, trying database fallback...');
                    
                    // Step 2: Fallback to direct database query
                    const dbData = await testDirectQuery();
                    if (dbData && dbData.length > 0) {
                        // Format database data like the hook does
                        videos = dbData.map(video => ({
                            id: video.id,
                            video_id: video.video_id,
                            title: video.title,
                            thumbnail: video.thumbnail_url,
                            videoId: video.video_id,
                            duration: video.duration,
                            views: formatViewCount(video.view_count),
                            publishedAt: formatPublishedDate(video.published_at),
                            isShort: video.is_short
                        }));
                    }
                }
                
                if (videos && videos.length > 0) {
                    logTest('useYouTubeVideos Hook Simulation', true, {
                        message: `Hook would return ${videos.length} videos`,
                        data: { 
                            videoCount: videos.length,
                            dataSource: videos[0]?.views ? 'Edge Function' : 'Database Fallback'
                        }
                    });
                    
                    displayVideoPreview(videos);
                    return videos;
                } else {
                    logTest('useYouTubeVideos Hook Simulation', false, {
                        error: 'Both edge function and database query failed',
                        message: 'Hook would fallback to mock data'
                    });
                    
                    // Show mock data that would be used
                    const mockVideos = getMockVideos();
                    displayVideoPreview(mockVideos);
                    return mockVideos;
                }
            } catch (error) {
                logTest('useYouTubeVideos Hook Simulation', false, {
                    error: error.message,
                    data: { errorType: error.name }
                });
                return [];
            }
        }

        function displayVideoPreview(videos) {
            const previewDiv = document.getElementById('video-preview');
            const gridDiv = document.getElementById('video-grid');
            
            if (videos && videos.length > 0) {
                previewDiv.style.display = 'block';
                gridDiv.innerHTML = videos.slice(0, 6).map(video => `
                    <div class="video-card">
                        <img src="${video.thumbnail || `https://img.youtube.com/vi/${video.video_id}/maxresdefault.jpg`}" 
                             alt="${video.title}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE2OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE2OCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjE1MCIgeT0iODQiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='"
                        >
                        <div class="video-card-content">
                            <div class="video-title">${video.title}</div>
                            <div class="video-meta">
                                ${video.duration} ‚Ä¢ ${video.views} ‚Ä¢ ${video.publishedAt}
                                ${video.isShort ? ' ‚Ä¢ Short' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function runAllTests() {
            clearResults();
            
            const runBtn = document.getElementById('run-all-btn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="loading"></span> Running Tests...';
            
            try {
                await testSupabaseConnection();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                
                await testDirectQuery();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testEdgeFunction();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await simulateHookBehavior();
                
                // Generate summary
                displayTestSummary();
                
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run All Tests';
            }
        }

        function displayTestSummary() {
            const totalTests = testResults.length;
            const passedTests = testResults.filter(t => t.success).length;
            const failedTests = totalTests - passedTests;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-section ${failedTests > 0 ? 'warning' : 'success'}`;
            
            summaryDiv.innerHTML = `
                <h3>üìä Test Summary</h3>
                <p><strong>Total Tests:</strong> ${totalTests}</p>
                <p><strong>Passed:</strong> ${passedTests}</p>
                <p><strong>Failed:</strong> ${failedTests}</p>
                <p><strong>Success Rate:</strong> ${Math.round((passedTests / totalTests) * 100)}%</p>
                
                ${failedTests > 0 ? `
                <h4>‚ùå Failed Tests:</h4>
                <ul>
                    ${testResults.filter(t => !t.success).map(t => `<li>${t.test}: ${t.details.error}</li>`).join('')}
                </ul>
                <h4>üîß Troubleshooting Tips:</h4>
                <ul>
                    <li>Check browser console for additional error details</li>
                    <li>Verify network connectivity and firewall settings</li>
                    <li>Try from different network/location</li>
                    <li>Check if browser extensions are blocking requests</li>
                    <li>Test in incognito/private browsing mode</li>
                </ul>
                ` : `
                <p class="success">üéâ All tests passed! Your YouTube integration is working correctly from the frontend perspective.</p>
                <p>If users are still reporting issues, it might be:</p>
                <ul>
                    <li>Device-specific problems (old browsers, mobile issues)</li>
                    <li>Geographic restrictions or network policies</li>
                    <li>Caching issues (suggest hard refresh)</li>
                    <li>Race conditions during page load</li>
                </ul>
                `}
            `;
            
            document.getElementById('test-results').appendChild(summaryDiv);
        }

        // Helper functions (same as in the hook)
        function formatViewCount(count) {
            const num = parseInt(count);
            if (num >= 1000000) {
                return `${(num / 1000000).toFixed(1)}M`;
            } else if (num >= 1000) {
                return `${(num / 1000).toFixed(1)}K`;
            }
            return num.toString();
        }

        function formatPublishedDate(publishedAt) {
            const now = new Date();
            const published = new Date(publishedAt);
            const diffMs = now.getTime() - published.getTime();
            
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            
            if (diffHours < 24) {
                return diffHours <= 1 ? '1 Stunde' : `${diffHours} Stunden`;
            } else if (diffDays < 7) {
                return diffDays === 1 ? '1 Tag' : `${diffDays} Tage`;
            } else if (diffWeeks < 4) {
                return diffWeeks === 1 ? '1 Woche' : `${diffWeeks} Wochen`;
            } else {
                return diffMonths === 1 ? '1 Monat' : `${diffMonths} Monate`;
            }
        }

        function getMockVideos() {
            return [
                {
                    id: 'mock1',
                    video_id: 'nBQKMPWrUgc',
                    title: 'CFO Transformation in 60 Sekunden',
                    thumbnail: 'https://img.youtube.com/vi/nBQKMPWrUgc/maxresdefault.jpg',
                    videoId: 'nBQKMPWrUgc',
                    duration: '0:58',
                    views: '1.2K',
                    publishedAt: '2 Tage',
                    isShort: true
                },
                {
                    id: 'mock2',
                    video_id: 'dQw4w9WgXcQ',
                    title: 'KI im Controlling - Game Changer?',
                    thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg',
                    videoId: 'dQw4w9WgXcQ',
                    duration: '0:45',
                    views: '892',
                    publishedAt: '5 Tage',
                    isShort: true
                }
            ];
        }
    </script>
</body>
</html>